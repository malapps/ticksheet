<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tick Sheet</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="icon" href="icon.png" sizes="any" type="image/png" />

<style>
    body {
        margin: 0;
        padding: 0;
        background: #F5F5F5;
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
    }

    .container {
        width: 100%;
        max-width: 480px;
        padding: 20px;
        box-sizing: border-box;
        text-align: center;
    }

    .logo {
        width: 150px;
        margin: 10px auto 14px auto;
        display: block;
    }

    /* Navigation bar */
    .nav-bar {
        margin-top: 10px;
        margin-bottom: 10px;
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        font-size: 17px;
    }

    .nav-btn {
        background: none;
        border: 2px solid transparent;
        padding: 6px 10px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 15px;
        transition: 0.2s;
    }

    .nav-btn:hover:not([disabled]) {
        border-color: #412d77;
        background: #f3f0fa;
    }

    .nav-btn[disabled] {
        opacity: 0.3;
        cursor: default;
    }

    .date-label {
        font-weight: bold;
        font-size: 17px;
    }

    .add-btn {
        margin-top: 20px;
        padding: 14px 20px;
        font-size: 16px;
        background: white;
        color: black;
        border: 2px solid #412d77;
        border-radius: 8px;
        cursor: pointer;
        display: inline-block;
    }

    .add-btn:hover {
        background: #f3f0fa;
    }

    .input-row {
        margin-top: 20px;
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
    }

    .pill-input {
        flex: 1;
        padding: 12px;
        font-size: 16px;
        border-radius: 12px;
        border: 1px solid #aaa;
        background: #fff;
        outline: none;
        transition: 0.2s;
    }

    .pill-input:focus {
        border-color: #412d77;
        box-shadow: 0 0 4px rgba(65, 45, 119, 0.6);
    }

    .save-btn {
        padding: 0 18px;
        font-size: 16px;
        background: white;
        color: black;
        border: 2px solid #412d77;
        border-radius: 8px;
        cursor: pointer;
    }

    .save-btn:hover {
        background: #f3f0fa;
    }

    @media (max-width: 480px) {
        .input-row {
            flex-direction: column;
            align-items: stretch;
        }

        .save-btn {
            width: 100%;
            padding-top: 14px;
            padding-bottom: 14px;
        }
    }

    .item-row {
        margin-top: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(255,255,255,0.7);
        padding: 8px 12px;
        border-radius: 10px;
        border: 2px solid transparent;
        transition: 0.2s;
    }

    .item-row.selected {
        border: 2px solid #412d77;
    }

    .item-label {
        font-size: 17px;
        text-align: left;
        flex: 1;
        cursor: pointer;
    }

    .checkbox-wrapper {
        position: relative;
        width: 24px;
        height: 24px;
        margin-left: 10px;
    }

    .checkbox-wrapper input {
        opacity: 0;
        width: 24px;
        height: 24px;
        position: absolute;
        left: 0;
        top: 0;
        cursor: pointer;
    }

    .custom-checkbox {
        width: 24px;
        height: 24px;
        border: 1px solid #999;
        border-radius: 6px;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        font-size: 18px;
        font-weight: bold;
        color: white;
        transition: 0.2s;
    }

    .checkbox-wrapper input:checked + .custom-checkbox {
        background: #05ffa1;
        border-color: #412d77;
    }

    .checkbox-wrapper input:checked + .custom-checkbox::after {
        content: "Y";
        color: white;
    }

    .icon-btn {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        margin-left: 10px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
    }

    .item-row.selected .icon-btn {
        opacity: 1;
        pointer-events: auto;
    }

    .icon-btn:hover {
        opacity: 0.7;
    }
</style>
</head>

<body>
<div class="container">

    <img src="tslogo.png" alt="Tick Sheet Logo" class="logo">

    <!-- NAVIGATION BAR -->
    <div id="navBar" class="nav-bar">
        <button id="prevBtn" class="nav-btn">◀ Previous</button>
        <span id="dateLabel" class="date-label">Today</span>
        <button id="nextBtn" class="nav-btn">Next ▶</button>
    </div>

    <div id="itemsList"></div>

    <!-- ADD BUTTON -->
    <div id="addArea">
        <button id="addItemBtn" class="add-btn">Add item</button>
    </div>

    <div id="inputArea"></div>

</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
/* ---------------- VANITY URL ---------------- */
function extractUserIdFromUrl() {
    const parts = window.location.pathname.split("/").filter(Boolean);
    const last = parts[parts.length - 1];
    if (!last || last.toLowerCase() === "ticksheet") return "nc";
    return last.toLowerCase();
}
const userId = extractUserIdFromUrl();

/* ---------------- AUTO-SAVE LAST USED SHEET ---------------- */
localStorage.setItem("lastSheet", userId);

/* ---------------- FIREBASE ---------------- */
const firebaseConfig = {
    apiKey: "AIzaSyAKux_A12z_UGBFhvVFiFCfbDG9pJGhcuQ",
    authDomain: "tick-17523.firebaseapp.com",
    projectId: "tick-17523",
    storageBucket: "tick-17523.firebasestorage.app",
    messagingSenderId: "935572869464",
    appId: "1:935572869464:web:e47e7c8fbf741573c4952d"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ---------------- DATE HELPERS ---------------- */
function getDateKeyFromOffset(offset) {
    const d = new Date();
    d.setDate(d.getDate() - offset);
    return d.toISOString().slice(0,10).replace(/-/g, "");
}

function getFriendlyDateLabel(offset) {
    if (offset === 0) return "Today";
    if (offset === 1) return "Yesterday";
    const d = new Date();
    d.setDate(d.getDate() - offset);
    return d.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
}

let currentOffset = 0;

/* ---------------- DOM ---------------- */
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const dateLabel = document.getElementById('dateLabel');
const addArea = document.getElementById('addArea');
const inputArea = document.getElementById('inputArea');
const itemsList = document.getElementById('itemsList');

function clearSelections() {
    document.querySelectorAll('.item-row').forEach(r => r.classList.remove('selected'));
}

/* ---------------- SHOW INPUT ---------------- */
function showInputRow() {
    addArea.innerHTML = "";
    inputArea.innerHTML = `
        <div class="input-row">
            <input type="text" id="pillInput" class="pill-input" placeholder="Type item name">
            <button class="save-btn" id="saveBtn">Save</button>
        </div>
    `;
    document.getElementById('saveBtn').addEventListener('click', saveItem);
}

/* ---------------- SAVE NEW ITEM ---------------- */
async function saveItem() {
    const input = document.getElementById('pillInput');
    const label = input.value.trim();
    if (!label) return;

    const dateKey = getDateKeyFromOffset(currentOffset);

    /* Save to today's list */
    await db.collection("users").doc(userId)
        .collection("days").doc(dateKey)
        .collection("items").doc(label)
        .set({ label: label, checked: false });

    /* Save to master list */
    await db.collection("users").doc(userId)
        .collection("master").doc(label)
        .set({ label: label });

    addItemToList(label, false);

    inputArea.innerHTML = "";
    addArea.innerHTML = `<button id="addItemBtn" class="add-btn">Add item</button>`;
    document.getElementById('addItemBtn').addEventListener('click', showInputRow);
}

/* ---------------- ADD ROW TO UI ---------------- */
function addItemToList(label, checked) {
    const row = document.createElement('div');
    row.className = 'item-row';

    row.innerHTML = `
        <div class="item-label">${label}</div>
        <label class="checkbox-wrapper">
            <input type="checkbox" ${checked ? "checked" : ""}>
            <span class="custom-checkbox"></span>
        </label>
        <button class="icon-btn delete-btn" title="Delete">✖</button>
    `;

    const checkbox = row.querySelector('input[type="checkbox"]');
    const deleteBtn = row.querySelector('.delete-btn');

    row.addEventListener('click', e => {
        if (e.target.tagName === "INPUT") return;
        clearSelections();
        row.classList.add('selected');
    });

    checkbox.addEventListener('change', () => {
        const dateKey = getDateKeyFromOffset(currentOffset);
        db.collection("users").doc(userId)
            .collection("days").doc(dateKey)
            .collection("items").doc(label)
            .set({ checked: checkbox.checked }, { merge: true });
    });

    deleteBtn.addEventListener('click', async () => {
        const dateKey = getDateKeyFromOffset(currentOffset);

        /* Delete from today's list */
        await db.collection("users").doc(userId)
            .collection("days").doc(dateKey)
            .collection("items").doc(label)
            .delete();

        /* Delete from master list */
        await db.collection("users").doc(userId)
            .collection("master").doc(label)
            .delete();

        row.remove();
    });

    itemsList.appendChild(row);
}

/* ---------------- LOAD ITEMS (MASTER + DAY MERGE) ---------------- */
async function loadItemsForOffset(offset) {
    itemsList.innerHTML = "";
    inputArea.innerHTML = "";

    addArea.innerHTML = `<button id="addItemBtn" class="add-btn">Add item</button>`;
    document.getElementById('addItemBtn').addEventListener('click', showInputRow);

    const dateKey = getDateKeyFromOffset(offset);

    /* Load master list */
    const masterSnap = await db.collection("users").doc(userId)
        .collection("master").get();

    const masterLabels = masterSnap.docs.map(d => d.id);

    /* Load today's list */
    const daySnap = await db.collection("users").doc(userId)
        .collection("days").doc(dateKey)
        .collection("items").get();

    const dayItems = {};
    daySnap.forEach(doc => dayItems[doc.id] = doc.data());

    /* Merge: ensure all master labels exist for today */
    for (const label of masterLabels) {
        if (!dayItems[label]) {
            await db.collection("users").doc(userId)
                .collection("days").doc(dateKey)
                .collection("items").doc(label)
                .set({ label: label, checked: false });
            dayItems[label] = { label: label, checked: false };
        }
    }

    /* Render */
    for (const label of Object.keys(dayItems)) {
        addItemToList(label, dayItems[label].checked);
    }

    dateLabel.textContent = getFriendlyDateLabel(offset);
    prevBtn.disabled = offset >= 9;
    nextBtn.disabled = offset <= 0;
}

/* ---------------- NAVIGATION ---------------- */
prevBtn.addEventListener('click', () => {
    if (currentOffset < 9) {
        currentOffset++;
        loadItemsForOffset(currentOffset);
    }
});

nextBtn.addEventListener('click', () => {
    if (currentOffset > 0) {
        currentOffset--;
        loadItemsForOffset(currentOffset);
    }
});

/* ---------------- INITIAL LOAD ---------------- */
loadItemsForOffset(0);

document.addEventListener('click', e => {
    if (!e.target.closest('.item-row')) clearSelections();
});
</script>

</body>
</html>